<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Demo of File Operations</title>
</head>
<body>
    <h1>File Operation Demo</h1>
    <button id="select-file">Select File</button>
    <button id="verify-permission">Verify Permission</button>
    <button id="remove-entry" style="display: none;">Remove Entry</button>
    <div id="file-list-container"></div>

    <div id="file-content-container"></div>

    <script src="./dist/index.js" type="module"></script>
    <script type="module">
        import {
            openDatabase,
            saveFileData,
            getFileData,
            deleteFileData,
            readFile,
            removeAllFileData,
            selectFile,
            verifyPermission,
            removeEntry
        } from './dist/index.js';
    
        const dbName = 'fileOperationsDB';
        const dbVersion = 1;
        let db;
    
        const btnSelectFile = document.getElementById('select-file');
        const btnVerifyPermission = document.getElementById('verify-permission');
        const btnRemoveEntry = document.getElementById('remove-entry');
        const fileContentContainer = document.getElementById('file-content-container');
        const fileListContainer = document.getElementById('file-list-container');
    
        let selectedFileHandle = null;
    
        async function initDB() {
            db = await openDatabase(dbName, dbVersion);
            console.log('Database initialized:', db);
            renderFileList();
        }
    
        async function renderFileList() {
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.getAll();
    
            request.onsuccess = () => {
                const files = request.result;
                fileListContainer.innerHTML = ''; 
                if (files && files.length > 0) {
                    files.forEach((file) => {
                        const fileElement = document.createElement('p');
                        fileElement.textContent = `File Name: ${file.name}, Last Modified: ${file.lastModified}`;
                        fileListContainer.appendChild(fileElement);
                    });
                } else {
                    fileListContainer.textContent = 'No files stored.';
                }
            };
        }

        btnSelectFile.addEventListener('click', async () => {
            selectedFileHandle = await selectFile();
            if (selectedFileHandle) {
                const fileData = { name: selectedFileHandle.name, lastModified: selectedFileHandle.lastModified };
                await saveFileData(db, fileData);
                console.log('Selected file handle:', selectedFileHandle);
                const hasPermission = await verifyPermission(selectedFileHandle, true);
                btnRemoveEntry.style.display = hasPermission ? 'block' : 'none';
                renderFileList();
                const content = await readFile(selectedFileHandle);
                const fileElement = document.createElement('p');
                fileElement.textContent = `File Content: ${content}`;
                fileContentContainer.appendChild(fileElement);
            }
        });
    
        btnVerifyPermission.addEventListener('click', async () => {
            if (!selectedFileHandle) {
                console.error('No file selected.');
                return;
            }
            const hasPermission = await verifyPermission(selectedFileHandle, true);
            console.log('Permission granted:', hasPermission);
            btnRemoveEntry.style.display = hasPermission ? 'block' : 'none';
        });
    
        btnRemoveEntry.addEventListener('click', async () => {

            if (!db) {
                console.error('Database not initialized.');
                return;
            }
            await removeAllFileData(db);
            console.log('All entries removed successfully.');
            btnRemoveEntry.style.display = 'none';
            renderFileList();
        });
    
        initDB();
    </script>
    
    
</body>
</html>
